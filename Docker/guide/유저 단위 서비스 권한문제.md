#### 유저단위 서비스
```less
/home/pi/.config/systemd/user/tornado.service
```

```less
[Unit]
Description=TornadoWebserver

[Service]
#User=pi
#Group=pi

# X11 환경 변수 설정
Environment=DISPLAY=:0
Environment="XAUTHORITY=/home/pi/.Xauthority"
ExecStart=/home/pi/www/shell/tornado.sh

Restart=on-failure
Restart=on-abort

[Install]
#WantedBy=multi-user.target
WantedBy=default.target
```

#### 유저 단위 서비스 자동 실행 설정
```less
systemctl --user daemon-reload
systemctl --user enable tornado.service
systemctl --user start tornado.service
systemctl --user status tornado.service
```

```less
# 부팅 후 자동실행
sudo loginctl enable-linger pi
```

#### 유저단위 서비스 기본 개념
```less
유저 단위 서비스는 명령어를 실행하는 사용자의 권한으로 실행됩니다.
~/.config/systemd/user/ 디렉토리에 서비스 파일을 저장하고

systemctl --user 명령으로 관리하는 서비스는 해당 명령어를 입력한 사용자의 권한으로 실행됩니다.

예를 들어, pi 사용자로 로그인한 상태에서 systemctl --user enable tornado.service와 같은 명령을 실행했다면,
이 서비스는 pi 사용자 권한으로 실행됩니다.
```

#### 유저 단위 서비스의 특징
```less
User=와 Group= 지시어가 필요 없습니다 (주석 처리된 이유)
해당 사용자가 로그인 상태일 때만 실행됩니다

WantedBy=default.target은 사용자 세션이 시작될 때 서비스가 자동으로 시작되도록 합니다

현재 설정된 서비스는 사용자 로그인 시 자동으로 시작되어 /home/pi/www/shell/tornado.sh 스크립트를 실행하며,
X11 디스플레이 환경 변수도 설정되어 있습니다.
```

#### 벨소리 브라우저 새로 열고 닫은 후 안나는 문제
```less
User=pi와 Group=pi를 지정했음에도 불구하고
sudo systemctl enable tornado.service와 같이 root 권한으로 서비스를 활성화하면,
서비스 자체는 지정된 User=pi로 실행됩니다.

그러나 이 경우에도 pi 사용자의 그래픽 환경(X11 세션)과 완전히 분리된 환경에서 실행되어 문제가 발생할 수 있습니다.
```

#### 핵심 이슈
```less
sudo systemctl로 시스템 서비스로 등록하면 부팅 시 자동 실행되지만, 로그인된 사용자의 그래픽 세션과는 분리됨
브라우저를 열거나 오디오를 재생하려면 X11 디스플레이 세션과 오디오 장치에 대한 접근 권한이 필요함
```

#### 해결 방법
```less
둘 중 하나 택 1
1. 시스템 서비스 대신 사용자 서비스로 전환 (systemctl --user)
2. 시스템 서비스에 필요한 환경 변수와 권한을 명시적으로 설정

User=pi를 지정해도 root 권한으로 실행되는 것이 아니라, 단지 pi 사용자로 프로세스를 실행하라는 지시일 뿐입니다.
그래픽 환경과 오디오 장치 접근에 필요한 환경 변수와 권한이 제대로 설정되어야 벨소리가 울리고 브라우저가 정상 작동합니다.
```

#### 왜 root일 때는 안 되고 pi일 때는 될까?
```less
정확히 말하면, root라서 "안 되는" 것이 아니라,
root로 실행될 때 그래픽 환경이나 오디오 같은 특정 리소스에 접근하는 "메커니즘"이 일반 사용자(pi)와 다르기 때문입니다.

핵심은 X Window System (X11)과 오디오 시스템(Pulseaudio/ALSA)의 보안 모델입니다.
```

#### X11 (그래픽 환경) 보안
```less
사용자 세션 중심: 리눅스의 그래픽 환경(X11)은 기본적으로 특정 사용자 세션을 중심으로 설계되었습니다.
로그인한 사용자만이 그 세션의 디스플레이, 키보드, 마우스 같은 리소스에 접근할 수 있도록 보안이 강화되어 있습니다.
```

```less
DISPLAY 환경변수: GUI 애플리케이션은 어떤 디스플레이에 자신을 그릴지 DISPLAY라는 환경변수를 통해 파악합니다 (예: :0는 첫 번째 디스플레이).
XAUTHORITY 파일: 로그인한 사용자에게는 ~/.Xauthority 파일이라는 것이 생성됩니다.

이 파일은 해당 사용자만이 X 서버에 접근할 수 있는 인증 토큰을 담고 있습니다.
다른 사용자가 이 파일 없이 X 서버에 접속하려고 하면 보안 때문에 차단됩니다.

root 문제: systemd 시스템 서비스(sudo systemctl start ...)는 기본적으로 백그라운드에서 실행되며,
로그인한 사용자의 X11 세션 환경 변수(DISPLAY, XAUTHORITY)를 자동으로 상속받지 못합니다.

root 사용자는 pi 사용자의 ~/.Xauthority 파일에 접근할 수 없으므로, GUI 애플리케이션이 화면에 나타날 수 없는 것입니다.
비록 서비스 파일에 Environment=DISPLAY=:0와 Environment="XAUTHORITY=/home/pi/.Xauthority"를 명시해도,

root 사용자가 pi 사용자의 홈 디렉토리에 있는 .Xauthority 파일을 읽거나 사용할 권한이 기본적으로 없거나,
X 서버 자체가 root가 아닌 해당 pi 사용자에게만 접근을 허용하기 때문입니다.
```

#### 오디오 시스템 (Pulseaudio/ALSA) 보안
```less
오디오도 X11과 유사하게 현재 로그인한 사용자 세션에 맞춰져 있습니다.
root 권한으로 실행되는 프로세스는 기본적으로 현재 로그인한 사용자의 오디오 출력 장치에 접근할 권한이 없습니다.
충돌 방지와 보안을 위해 다른 사용자의 오디오 스트림을 가로채거나 엉망으로 만들 수 없도록 제한됩니다.
```

#### 요약
```less
root는 모든 파일에 접근할 수 있고, 모든 명령을 실행할 수 있는 '최고 관리자'입니다.
이는 시스템 전체의 파일을 건드리고, 서비스 데몬을 띄울 수 있는 권한을 의미합니다.

하지만 root가 곧 현재 '로그인된 사용자의 세션'을 의미하지는 않습니다.
root는 기본적으로 로그인된 사용자의 그래픽/오디오 세션과는 별개의, 더 낮은 계층의 시스템 레벨에서 작동합니다.

따라서 root가 직접 로그인한 사용자의 화면이나 스피커를 사용하려고 하면 "권한이 없다"기보다는 "그렇게 설계된 인터페이스가 아니다"에 가깝습니다.

마치 건물의 경비 반장(root)은 건물의 모든 문을 열 수 있지만,
특정 방의 주인(pi 사용자)만 사용할 수 있는 개인 화장실(X11 세션)은 사용할 수 없는 것과 비슷합니다.

그래서 GUI/오디오 관련 애플리케이션은 대부분 User=pi와 같이 로그인한 사용자의 권한으로,
그리고 사용자 레벨 systemd 서비스(systemctl --user)를 통해 실행하는 것이 가장 좋습니다.

이렇게 해야 해당 사용자의 X11 세션과 오디오 장치에 대한 접근 권한을 자연스럽게 물려받아 정상적으로 동작할 수 있습니다.
```








































































