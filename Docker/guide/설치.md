#### 1. 시스템 업데이트
```less
sudo apt-get update
sudo apt-get upgrade -y
```

#### 2. 필요한 패키지를 설치
```less
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg2 software-properties-common
```

#### 3. Docker의 공식 GPG 키를 추가
```less
curl -fsSL https://download.docker.com/linux/$(. /etc/os-release; echo "$ID")/gpg | sudo apt-key add -
```


#### 4. Docker 저장소를 추가
```less
echo "deb [arch=armhf] https://download.docker.com/linux/$(. /etc/os-release; echo "$ID") $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list
```

#### 5. 다시 패키지 목록을 업데이트
```less
sudo apt-get update
```

#### 6. Docker를 설치
```less
sudo apt-get install -y docker-ce docker-ce-cli containerd.io
```

#### 6-1. 빌드 과정 에러 발생 대처
```less
# Docker 서비스가 실행 중인지 확인
sudo systemctl status docker

# 서비스가 실행 중이 아니라면 시작
sudo systemctl start docker
```

#### 6-2
```less
# Docker 그룹에 사용자 추가
sudo usermod -aG docker $USER

# Docker Compose 프로젝트 디렉토리로 이동
cd ~/smartdoor_docker

# Docker Compose로 컨테이너를 다시 빌드하고 시작
docker-compose up -d --build

# requests 라이브러리 다운그레이드
sudo pip uninstall requests
sudo pip install requests==2.31.0

sudo systemctl status docker
sudo systemctl restart docker
```

#### 6-3
```less
# docker 패키지를 특정 버전으로 다운그레이드
sudo pip uninstall docker
sudo pip install docker==6.1.3

# docker-compose 재설치
sudo pip uninstall docker-compose
sudo pip install docker-compose

# Docker 소켓 권한 설정
sudo chmod 666 /var/run/docker.sock

# Docker 서비스 재시작
sudo systemctl restart docker

# 환경 변수 설정
export DOCKER_HOST=unix:///var/run/docker.sock

pip cache purge
sudo apt update

```

#### 7. Docker가 제대로 설치되었는지 확인
```less
sudo docker run hello-world
```

#### 8. (선택사항) sudo 없이 Docker를 사용할 수 있도록 설정
```less
sudo usermod -aG docker $USER
```

#### 9. Docker Compose 설치하기
```less
sudo apt-get update
sudo apt-get install -y python3-pip
sudo pip3 install docker-compose
```

#### 10. 애플리케이션 파일 준비
```less
# 프로젝트 폴더 생성
mkdir ~/smartdoor_docker
cd ~/smartdoor_docker
```

#### 11. requirements.txt 파일을 생성
```less
# 정리해둔 내용 복사
nano requirements.txt
```

#### 12. Dockerfile 생성
```less
cd ~/smartdoor_docker

nano Dockerfile
```

```less
FROM python:3.9-slim

WORKDIR /app/www  # 작업 디렉토리를 www 폴더로 변경

# 시스템 의존성 패키지 설치
RUN apt-get update && apt-get install -y \
    build-essential cmake \
    libsm6 libxext6 libxrender-dev \
    libgtk-3-dev \
    && rm -rf /var/lib/apt/lists/*

# requirements.txt 복사 및 패키지 설치 (상위 폴더에 있다고 가정)
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r /app/requirements.txt

# 애플리케이션 파일 복사
COPY ./www/ .  # www 폴더의 내용만 /app/www로 복사

# 애플리케이션 실행 (python 폴더 내 webserver.py 실행 가정)
CMD ["python", "python/webserver.py"]
```

#### 위에 꺼 에러 나서 변경 한거
```less
FROM python:3.9-slim

WORKDIR /app/www

# 시스템 의존성 패키지 설치
# build-essential, cmake, gcc, gfortran, pkg-config: 컴파일 도구
# python3-dev: Python 개발 헤더
# libsm6, libxext6, libxrender-dev, libgtk-3-dev: (만약 OpenCV 같은 GUI/이미지 처리 라이브러리를 사용한다면 필요)
# libblas-dev, liblapack-dev: 과학 계산 라이브러리(NumPy, SciPy)의 저수준 의존성
# python3-numpy, python3-scipy: 시스템 패키지 매니저를 통해 미리 컴파일된 NumPy/SciPy 설치
# libffi-dev: cffi 컴파일에 필요한 라이브러리 (이전 cffi 오류 때문에 추가됨)
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgtk-3-dev \
    python3-dev \
    libblas-dev \
    liblapack-dev \
    gcc \
    gfortran \
    pkg-config \
    python3-numpy \
    python3-scipy \
    libffi-dev \
    --no-install-recommends && \
    rm -rf /var/lib/apt/lists/*

# requirements.txt 복사
COPY requirements.txt /app/

# pip 업그레이드 및 빌드 도구 설치
RUN pip install --upgrade pip
RUN pip install --no-cache-dir setuptools wheel

# ----- 핵심 변경 부분 -----
# `pip`에게 numpy가 이미 설치되어 있다고 가정하도록 fake 패키지를 설치합니다.
# 이렇게 하면 requirements.txt의 다른 패키지들이 numpy에 의존하더라도
# pip이 numpy를 직접 빌드하려고 시도하지 않게 됩니다.
# apt-get으로 설치된 python3-numpy가 실제로 사용됩니다.
RUN pip install --no-cache-dir "numpy!=1.20.0" # 임의의 호환 버전 명시 (실제로는 사용되지 않음)

# requirements.txt에 있는 패키지 설치
# --no-deps 옵션을 사용하지만, 이미 numpy는 건너뛰도록 처리했습니다.
RUN pip install --no-cache-dir -r /app/requirements.txt --no-deps

# 애플리케이션 파일 복사
COPY ./www/ .

# 애플리케이션 실행
CMD ["python", "python/webserver.py"]
```


#### 13. docker-compose.yml 생성
```less
nano docker-compose.yml
```

```less
version: '3'
services:
  tornado:
    build: .
    container_name: smartdoor_app
    ports:
      - "8080:8080"  
    restart: unless-stopped
    volumes:
      - ./www:/app/www
```

#### 14. nginx root 경로 변경

#### 15. 숨김 파일 뺴고 파일 복사
```less
cp -r /home/pi/www/[^.]* ~/smartdoor_docker/www/
```

#### 16. 유저 단위 서비스 중지
```less
# user 단위 서비스 경로
/home/pi/.config/systemd/user

systemctl --user stop tornado.service
systemctl --user disable tornado.service
```

#### 17. 유저 단위 서비스 파일 생성
```less
mkdir -p ~/.config/systemd/user
nano ~/.config/systemd/user/smartdoor_docker.service
```

```less
[Unit]
Description=Smartdoor Docker Application
After=network-online.target graphical.target

[Service]
WorkingDirectory=/home/pi/smartdoor_docker
ExecStart=/usr/local/bin/docker-compose up --build
ExecStop=/usr/local/bin/docker-compose down

Environment=DISPLAY=:0
Environment="XAUTHORITY=/home/pi/.Xauthority"

Restart=always
RestartSec=10s

[Install]
WantedBy=default.target
```
```less
systemctl --user daemon-reload
systemctl --user enable smartdoor_docker.service
systemctl --user start smartdoor_docker.service
```
















