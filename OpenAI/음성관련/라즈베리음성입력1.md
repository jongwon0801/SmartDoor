#### 패키지 설치

```less
sudo apt-get update

pip install sounddevice

pip install soundfile

sudo apt-get install libportaudio2
```

#### sounddevice 연결된 디바이스 출력

```less
import sounddevice as sd
print(sd.query_devices())

# device=2번 (USB 4K Live Camera)
import sounddevice as sd
device_info = sd.query_devices(2, 'input')
print(device_info)


# 기본 입력 및 출력 장치를 'default'(12번)로 복원
import sounddevice as sd
sd.default.device = (12, 12)
```


```less
# Python 내에서 확인 (웹서버나 스크립트에서)
import os
print("XDG_RUNTIME_DIR =", os.environ.get("XDG_RUNTIME_DIR"))
print("PULSE_SERVER =", os.environ.get("PULSE_SERVER"))

# 터미널에서 확인
echo $XDG_RUNTIME_DIR
echo $PULSE_SERVER


# PulseAudio 소켓 파일 존재 여부 확인
ls -l /run/user/1000/pulse/native

# PulseAudio 실행 여부 확인
ps aux | grep pulseaudio
```

```less
⚠️ 문제 요점
웹서버나 Python 백그라운드 스레드에서는 PULSE_SERVER 환경 변수가 없으므로 PulseAudio에 연결이 안 됩니다.

그래서 "파일은 만들어지는데 음성 없음" 문제가 발생합니다 (무음 녹음)
```

✅ **현재 상태 요약**

| 항목                                 | 상태                                               |
|--------------------------------------|----------------------------------------------------|
| `pulseaudio`                         | 정상 실행 중 (`/usr/bin/pulseaudio ...`)           |
| `/run/user/1000/pulse/native`        | 존재함 (소켓 OK)                                   |
| `$XDG_RUNTIME_DIR`                   | `/run/user/1000` (정상)                            |
| `$PULSE_SERVER`                      | 비어 있음 (환경 변수 설정 필요)                   |
| `Python 내 os.environ['PULSE_SERVER']` | `None` (환경 변수 미설정)                          |

```less
import sounddevice as sd

print("사용 가능한 오디오 장치 리스트:")
for i, device in enumerate(sd.query_devices()):
    print(f"{i}: {device['name']} (max input channels: {device['max_input_channels']})")
```

```less
device=2 (USB Audio Device)는 입력 채널 0 → 녹음 불가

device=3 (USB 4K Live Camera: Audio)는 입력 채널 1 → 녹음 가능

device=8 (pulse)와 device=12 (default)는 입력 채널 32 → PulseAudio 가상 장치, 녹음 가능
```

결론 및 권장 설정
device=3 을 녹음 장치로 사용해야 합니다. (모노 1채널)

channels=1 로 녹음 시도


#### test_voice.py
```less
print("시작")  # ← 이 줄이 출력되는지 확인

import sounddevice as sd
import soundfile as sf
import time

print("🎙️ 음성 녹음 시작... 4초간 말해주세요.")
try:
    duration = 4
    sample_rate = 24000
    device = 2

    recording = sd.rec(
        int(duration * sample_rate),
        samplerate=sample_rate,
        channels=1,
        device=device,
    )
    sd.wait()
    sf.write("user_voice.wav", recording, sample_rate)
    print("✅ 녹음 완료: user_voice.wav")
except Exception as e:
    print(f"❌ 오류 발생: {e}")
```

```less
import os
import time
import sounddevice as sd
import soundfile as sf

def voice_record(
    duration=4,
    sample_rate=24000,
    filename="user_voice.wav",
    folder="/home/pi/guest_voice",
) -> str:
    # PulseAudio 환경변수 설정 (현재 프로세스에만 영향)
    os.environ["XDG_RUNTIME_DIR"] = "/run/user/1000"
    os.environ["PULSE_SERVER"] = "unix:/run/user/1000/pulse/native"

    print("[voice_record] 시작")

    if not os.path.exists(folder):
        print(f"[voice_record] 폴더가 없어서 생성: {folder}")
        os.makedirs(folder)

    filepath = os.path.join(folder, filename)

    print(f"🎙️ 음성 녹음 시작... {duration}초간 말해주세요.")

    try:
        recording = sd.rec(
            int(duration * sample_rate),
            samplerate=sample_rate,
            channels=1,
            device=3,  # USB 4K Live Camera 마이크 입력 장치 번호
        )
        sd.wait()

        sf.write(filepath, recording, sample_rate)
        print(f"✅ 녹음 완료, 파일 저장: {filepath}")

        time.sleep(0.5)
        return filepath

    except Exception as e:
        print(f"[record_user_voice 오류] {e}")
        return ""

if __name__ == "__main__":
    recorded_file = voice_record()
    if recorded_file:
        print(f"녹음 파일 위치: {recorded_file}")
    else:
        print("녹음 실패")

```

#### 터미널에서 녹음된 음성 출력

```less
aplay /home/pi/guest_voice/user_voice.wav
```
