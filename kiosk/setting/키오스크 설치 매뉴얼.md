#### 1 라즈베리파이 os imager 로 설치
```less
라즈베리4 모델 b / 64bit bullseye desktop full 버젼

cat /etc/os-release

cat /proc/cpuinfo
```

#### 2 ssh 설정(raspberrypi)
```less
sudo raspi-config 
 
Interface Options → SSH (yes 설정) 
 
sudo systemctl status ssh
```

#### 3 화면 방향 설정
```less
configuration -> interface -> 화면 left 이동

sudo nano /boot/config.txt

# 맨 밑에 추가
# 화면을 오른쪽(시계 방향) 으로 90 회전
display_rotate = 1 (0 = 0도, 1 = 90도, 2 = 180도, 3 = 270도)
```

#### 4 전체 프로그램 업데이트
```less
sudo apt clean
sudo apt autoremove -y 
 
sudo apt update 
sudo apt upgrade
```

#### 5 ibus 한글 입력기 설치
```less
출력: 한글 출력은 폰트와 로케일 설정에 의해 결정됩니다. (따라서 IBus 없이도 가능)

입력: 한글 입력은 키보드 입력기(예: IBus, Fcitx 등)가 있어야 가능합니다.
```
```less
sudo apt update

sudo apt install ibus ibus-hangul ibus-gtk3

ibus-daemon -drx

# 한글 글꼴 깨짐 위해 폰트 설치(install 해야함 글꼴 복사로 안됨)
sudo apt install fonts-nanum fonts-unfonts-core
```

#### 6 터치 스크린 설정
```less
sudo apt update
sudo apt full-upgrade 
 
sudo nano /usr/share/X11/xorg.conf.d/40-libinput.conf  
 
sudo systemctl restart lightdm 
```

```less
Section "InputClass" 
       Identifier "libinput touchscreen catchall" 
       MatchIsTouchscreen "on" 
       #Option "TransformationMatrix" "0 -1 1 1 0 0 0 0 1" 
       Option "TransformationMatrix" "0 1 0 -1 0 1 0 0 1" 
       MatchDevicePath "/dev/input/event*" 
       Driver "libinput" 
EndSection
```

#### 7 해상도 설정
```less
# 들어가서 아래 두개 주석해제 
sudo nano /boot/config.txt 
 
# 모니터가 자동으로 감지되지 않을 때 HDMI 출력이 항상 활성화되므로, 모니터나 TV가 HDMI 신호를 제대로 인식
# 모니터 없이 원격으로 Raspberry Pi를 설정할 때 외부 모니터 화면을 확인 가능 
hdmi_force_hotplug=1 
 
#HDMI 장치(모니터, TV 등)에서 비디오와 오디오를 모두 출력하고자 할 때 사용 
hdmi_drive=2
```

#### 8 네트워크 관리방법 NetworkManager 변경
```less
(Raspberry Pi에 데스크탑 환경이 있고 GUI에서 네트워크 설정을 바꾸고 싶을 때 사용)
sudo raspi-config 
 
Advanced Options -> Network Config -> NetworkManager
```

#### 9. nginx 설치, nginx.conf 설정
```less
sudo apt-get install nginx
sudo nano /etc/nginx/nginx.conf
이유 : 클라이언트가 전송하는 데이터 크기를 제한하지 않아서 대용량 파일 업로드나 특정 상황에서 데이터를 제한 없이 전송할 수 있도록 하기 위해서
```
```less
http {
client_max_body_size 0;
include /etc/nginx/conf.d/.conf;
include /etc/nginx/sites-enabled/;
}
```

#### 10. localhost.conf 파일 생성 수정
```less
sudo nano /etc/nginx/conf.d/localhost.conf
이유 : HTTP 요청과 WebSocket 요청을 처리하는 웹 서버를 설정
```

```less

server {
    listen 80;
    server_name 127.0.0.1 localhost;
    charset utf-8;

    #access_log /var/log/nginx/host.access.log main;

    location / {
        root /home/pi/www;
        index index.html index.htm;
    }

    location ^~ /ws/ {
        rewrite ^/ws/(.*)$ /ws/$1 break;
        proxy_pass http://127.0.0.1:8080/ws/$1;
        proxy_http_version 1.1;
        proxy_set_header upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    #error_page 404 /404.html;

    # redirect server error pages to the static page /50x.html
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}

```

#### 11. Nginx 재실행
```less
sudo systemctl restart nginx
sudo service nginx restart
```

#### 12. DB의 root 계정 비밀번호 설정, hizib DB생성 
```less
sudo apt-get install mariadb-server

sudo mysql -u root

set password for root@'localhost'=PASSWORD('dnlzlqkrtm');

flush privileges;

create database hizib;

SHOW DATABASES;

USE hizib;

Exit
```

#### 13. 프로그램 소스 www 폴더 복사
```less
www 폴더만 압축
tar -czvf kiosk.tar.gz www
-c (create): 아카이브 생성 - 새로운 tar 파일을 생성
-z (gzip): gzip으로 압축 - .gz 형식으로 압축
-v (verbose): 진행 상황 표시 - 처리 중인 파일 목록을 출력
-f (file): 파일 이름 지정 - 대상 아카이브 파일 이름을 지정
```


#### 14. sftp 명령어로 압축파일 전송
```less
sftp pi@192.168.0.3
get /home/pi/kiosk.tar.gz /home/pi
```

```less
# 현재 경로에 압축해제
tar -xzvf kiosk.tar.gz -C /home/pi

-x (extract): 압축을 풀기 위해 사용
-z (gzip): .gz 형식의 gzip 압축을 해제
-v (verbose): 압축을 푸는 과정을 화면에 출력 (파일 목록이 보임)
-f (file): 대상이 되는 파일 이름을 지정
```

#### 15-1. 가상환경 설치
```less
pip install virtualenv
-> Location: /home/pi/.local/lib/python3.9/site-packages
pip install virtualenvwrapper
-> Location: /home/pi/.local/lib/python3.9/site-packages
```


#### 15-2. 로그인 시 자동으로 wrapper 실행 설정
```less
sudo nano ~/.profile 하단에 입력
source /home/pi/.local/bin/virtualenvwrapper.sh (192.168.0.3 이랑 sh 파일 위치가 다름)
-> login 하면 workon 명령어 사용 가능
sudo reboot
```

#### 16. 가상환경 폴더 생성
```less
mkvirtualenv elcsoft
/home/pi/.virtualenvs/elcsoft 위치에 가상환경 폴더 생성됨

# 가상환경 켜고 패키지 설치하면 이 경로에 파이썬 패키지들이 설치됨
/home/pi/.virtualenvs/elcsoft/lib/python3.9/site-packages

일반적으로 --user로 설치한 패키지는 ~/.local/lib/pythonX.X/site-packages에 저장됨
```

#### 17. 의존성 패키지 제외하고 설치
```less
Requirement.txt

oauthlib==3.1.0
requests==2.25.1
requests-oauthlib==1.0.0
PyJWT==1.7.1
paho-mqtt==2.1.0
numpy==1.19.5
pycryptodome==3.20.0
pyserial==3.5b0
pyOpenSSL==20.0.1
pylint==2.7.2

pip install -r requirements.txt
```

#### 18. webserver.py 실행하면서 나머지 패키지 설치 (의존성이 꼬여서 한번에 설치 불가능)

```less
pip install firebase-admin
pip install Pillow
pip install qrcode
pip install pyzbar
pip install PyMySQL
pip install DBUtils
pip install websockets
pip install gTTS
pip install pydub
pip install nmcli
pip install RPi.GPIO
pip install gpiozero
pip install python-vlc
pip install lgpio
pip install opencv-python
pip install face-recognition   
pip install dlib
```

#### 20. face_recognition 설치
```less
face_recognition은 dlib 라이브러리를 기반으로 작동하므로, dlib의 빌드에 필요한 패키지들을 먼저 설치해야 합니다
```

#### 21. 필수 의존성 설치
```less
sudo apt update
sudo apt install -y build-essential cmake libopenblas-dev liblapack-dev libx11-dev libgtk-3-dev libboost-all-dev
sudo apt install -y python3-dev python3-pip
```

#### 22. SWAP 파일 크기 변경
```less
sudo nano /etc/dphys-swapfile
# CONF_SWAPSIZE 값을 2048 (2GB) 또는 4096 (4GB)로 수정
CONF_SWAPSIZE=4096
```

#### 22. SWAP 서비스 재시작
```less
sudo dphys-swapfile setup sudo dphys-swapfile swapon
```

#### 23. 패키지 설치 중 에러 발생 시 해결법
```less
# 캐시삭제
pip cache purge

# 리눅스 패키지 목록(데비안 계열)의 최신 상태로 갱신
sudo apt update

# 현재 시스템에 설치된 pip을 최신 버전으로 업그레이드
pip install --upgrade pip
```

#### 24. 얼굴인식 관련 패키지 설치
```less
pip install face_recognition
```
```less
# 실패시 해시 무시하고 강제 설치
pip install --no-cache-dir --no-deps face-recognition
```
```less
# face_recognition 패키지를 사용하기 전에 face_recognition_models 라이브러리를 설치
pip install git+https://github.com/ageitgey/face_recognition_models
```

#### 25-1. ttyUSB 심볼릭 링크 설정 (192.168.0.3)
```less
sudo nano /etc/udev/rules.d/99-com.rules

SUBSYSTEM=="pwm", ACTION!="remove", PROGRAM="/bin/sh -c 'chgrp -R gpio /sys%p && chmod -R g=u /sys%p'"

# 두줄 추가
SUBSYSTEM=="tty", ATTRS{idVendor}=="1d6b", ATTRS{idProduct}=="0002", SYMLINK+="hione"
SUBSYSTEM=="tty", ATTRS{idVendor}=="04d8", ATTRS{idProduct}=="000a", SYMLINK+="ttyUSB_PIR"

# Udev 서비스를 재시작 하거나 리부팅
sudo udevadm control --reload-rules
sudo reboot
```
#### 25-2 ttyUSB 심볼릭 링크 설정 (192.168.0.42)
```less
sudo nano /etc/udev/rules.d/99-com.rules

SUBSYSTEM=="pwm", ACTION!="remove", PROGRAM="/bin/sh -c 'chgrp -R gpio /sys%p && chmod -R g=u /sys%p'"
SUBSYSTEM=="tty", ATTRS{idVendor}=="04d8", ATTRS{idProduct}=="000a", SYMLINK+="ttyUSB_PIR"
SUBSYSTEM=="video4linux", SUBSYSTEMS=="usb", ATTRS{idVendor}=="1e45", ATTRS{idProduct}=="8022", SYMLINK+="cam_inside"
SUBSYSTEM=="video4linux", SUBSYSTEMS=="usb", ATTRS{idVendor}=="0c45", ATTRS{idProduct}=="0415", SYMLINK+="cam_outside">

# uart-5 의 attribute
KERNELS=="fe201a00.serial", SYMLINK+="hione"
```

```less
# Udev 서비스를 재시작 하거나 리부팅
sudo udevadm control --reload-rules
sudo reboot
```

#### ~/www/python/config.json 차이점
```less
192.168.0.3 (도어클로저 o 문)
192.168.0.42 (도어클로저 x 문)
```
```less
# 192.168.0.3 
"pir_inside": {"pin": 14, "times": 30, "isDoorcloserSafeMode": true}, 
 
# 192.168.0.42 
"pir_inside": {"pin": 25, "times": 30, "isDoorcloserSafeMode": false} 
 
 
# 192.168.0.3  
"doorcloser": {"pin": 21, "safe_pin": 15, "checktimes": 0, "delaytime": 0.2, "isUse": true, "file":"/home/pi/www/sound/open_g10.wav"} 
 
# 192.168.0.42 
"doorcloser": {"pin": 23, "safe_pin": 24, "checktimes": 0, "delaytime": 0.2, "isUse": false, "file":"/home/pi/www/sound/open_g10.wav"} 
 
 
# 192.168.0.3 
"doorlock": "/dev/ttyUSB0" 
 
# 192.168.0.42 
"doorlock": "/dev/hione" 
 
 
# 192.168.0.3 
"isUseRecord": true 
 
# 192.168.0.42 
"isUseRecord": false 
 
 
# 192.168.0.3 
"outsideSpeakerDevice": {"player":"vlcPlayer", "device":"iec958:CARD=Device,DEV=0", "aout":"alsa"} 
 
# 192.168.0.42 
"outsideSpeakerDevice": {"player":"vlcPlayer", "device":"iec958:CARD=Device,DEV=0", "aout":""} 
 
 
# 192.168.0.3 
"isShowOutsidePicture": true 
 
 
# 192.168.0.42 
"isShowOutsidePicture": false
```

```less
/boot/config.txt HDMI 포트 0 강제 활성화

hdmi_force_hotplug:0=1: 다중 포트 장치에서 특정 포트(HDMI0)를 강제 활성화.

192.168.0.3
[all] gpu_mem=128
#enable_uart=1
#dtoverlay=uart0
#dtoverlay=uart1
#dtoverlay=uart2
#dtoverlay=uart3
#dtoverlay=uart4
#dtoverlay=uart5

192.168.0.42
[all] gpu_mem=128
#enable_uart=1
#dtoverlay=uart0
#dtoverlay=uart1
#dtoverlay=uart2
#dtoverlay=uart3
#dtoverlay=uart4
dtoverlay=uart5
dtoverlay=uart5 gpio uart5 5의 기능 활성화
```

#### 28. tornado 설치
```less
pip install tornado
```

#### 29. /home/pi/www/shell/tornado.sh 셸 수정
```less
(가상환경 경로 맞춰줘야함)

# elcsoft 가상 환경의 Python 인터프리터로 webserver.py 모듈 실행
/home/pi/.virtualenvs/elcsoft/bin/python /home/pi/www/python/webserver.py
```

#### 30. Tornado.service 설정
```less
tornado.sh 를 tornado.service 파일에 넣어서 autostart 할 때 사용
```

#### 31. 유저 단위 서비스 설정
```less
/home/pi/.config/systemd/user/tornado.service
mkdir -p ~/.config/systemd/user
유저 단위 서비스 ~/.config/systemd/user/ 에 작성
```

```less
[Unit]
Description=TornadoWebserver

[Service]
#User=pi
#Group=pi

# X11 환경 변수 설정
Environment=DISPLAY=:0
Environment="XAUTHORITY=/home/pi/.Xauthority"
ExecStart=/home/pi/www/shell/tornado.sh

Restart=on-failure
Restart=on-abort

[Install]
#WantedBy=multi-user.target
WantedBy=default.target
```

#### 32. 유저 단위 서비스 자동 실행 설정
```less
systemctl --user daemon-reload
systemctl --user enable tornado.service
systemctl --user start tornado.service
systemctl --user status tornado.service

systemctl --user disable tornado.service
```
```less
# 부팅 후 자동실행
sudo loginctl enable-linger pi
```

#### 33. chromium 설치
```less
sudo apt update

sudo apt install chromium-browser -y

chromium-browser
```

#### 34. autostart 설정
```less
sudo nano /etc/xdg/lxsession/LXDE-pi/autostart

@lxpanel --profile LXDE-pi
@pcmanfm --desktop --profile LXDE-pi
@xscreensaver -no-splash

@chromium-browser --kiosk --autoplay-policy=no-user-gesture-required --check-for-update-interval=31536000 http://127.0.0.1
#@chromium-browser http://127.0.0.1
```
```less
Chromium 브라우저가 제대로 실행되지 않을 때 사용하는 "초기화 및 재부팅" 조치

pkill chromium

cd ~/.config/chromium/

rm -f SingletonLock

rm -f SingletonSocket

sudo reboot
```
